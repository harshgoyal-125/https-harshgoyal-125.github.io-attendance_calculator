<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">ERP Attendance Manager</h1>
                <p class="text-slate-500 text-sm">Paste your table including the "Makeup" column below.</p>
            </div>
            
            <div class="flex gap-4">
                <div class="bg-red-50 border border-red-200 px-6 py-3 rounded-xl text-center shadow-sm">
                    <p class="text-xs font-bold text-red-400 uppercase tracking-wider">Must Attend</p>
                    <p class="text-2xl font-extrabold text-red-600" id="totalNeed">0</p>
                    <p class="text-xs text-red-400">Hours Total</p>
                </div>
                <div class="bg-green-50 border border-green-200 px-6 py-3 rounded-xl text-center shadow-sm">
                    <p class="text-xs font-bold text-green-400 uppercase tracking-wider">Safe Bunks</p>
                    <p class="text-2xl font-extrabold text-green-600" id="totalBunk">0</p>
                    <p class="text-xs text-green-400">Hours Total</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-5 rounded-xl shadow border border-slate-200">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Target Percentage (%)</label>
                    <input type="number" id="target" value="75" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-indigo-500 outline-none">
                    
                    <label class="block text-sm font-bold text-slate-700 mt-4 mb-2">Paste Attendance Data</label>
                    <textarea id="inputData" rows="12" class="w-full p-3 border border-slate-300 rounded text-xs font-mono focus:ring-2 focus:ring-indigo-500 outline-none whitespace-pre" placeholder="Paste full table here..."></textarea>
                    
                    <button onclick="calculateAttendance()" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition">
                        Analyze Attendance
                    </button>
                    <button onclick="loadSampleData()" class="w-full mt-2 text-indigo-600 text-xs font-semibold hover:underline">
                        Load Sample Data
                    </button>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-3">Subject</th>
                                    <th class="px-6 py-3 text-center">Type</th>
                                    <th class="px-6 py-3 text-center">Attended / Total</th>
                                    <th class="px-6 py-3 text-center">Current %</th>
                                    <th class="px-6 py-3 text-center">Result</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <tr>
                                    <td colspan="5" class="px-6 py-10 text-center text-slate-400">
                                        Paste your ERP data and click Analyze
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function loadSampleData() {
            // Updated sample with "Makeup" column
            const sample = `1	HSUL401	Managerial Economics and Financial Accounting	Lecture	1	0	0	1	50.00
2	ITUL401	Database Management System	Lecture	2	0	0	1	66.67
3	ITUL402	Theory of Computation	Lecture	2	0	0	2	50.00
4	ITUL403	Computer Networks	Lecture	3	0	0	0	100.00
5	ITUL404	Artificial Intelligence	Lecture	0	0	0	1	0.00
6	ITUL405	Computer Architecture and Microprocessor	Lecture	3	0	0	0	100.00
7	ITUP420	Database Systems Lab	Lab	3	0	0	3	50.00
8	ITUP421	Network Programming Lab	Lab	3	0	0	3	50.00
9	ITUP422	Web Development Lab	Lab	3	0	0	0	100.00
10	MAUL402	Discrete Mathematics and Linear Algebra	Lecture	1	0	0	3	25.00
11	NU99.4	Technical Training	Lab	1	0	0	2	33.33`;
            document.getElementById('inputData').value = sample;
        }

        function calculateAttendance() {
            const input = document.getElementById('inputData').value;
            const target = parseFloat(document.getElementById('target').value);
            const tbody = document.getElementById('resultsBody');
            
            // Clear previous results
            tbody.innerHTML = '';
            let globalNeed = 0;
            let globalBunk = 0;

            const lines = input.split('\n');
            let hasData = false;

            lines.forEach(line => {
                // Regex Breakdown:
                // 1. Start with Number (Index)
                // 2. Code (e.g., HSUL401)
                // 3. Name (Anything until Type)
                // 4. Type (Lecture/Lab)
                // 5. Present (Digit)
                // 6. OD (Digit)
                // 7. Makeup (Digit) <-- NEW
                // 8. Absent (Digit)
                // 9. Percentage
                
                const regex = /^\s*(\d+)\s+([A-Z0-9.]+)\s+(.+?)\s+(Lecture|Lab)\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)\s+([\d.]+)/i;
                
                // Trim line to ensure no leading garbage breaks the regex
                const cleanLine = line.trim();
                const match = cleanLine.match(regex);

                if (match) {
                    hasData = true;
                    
                    const subjectName = match[3];
                    const type = match[4];
                    const present = parseInt(match[5]);
                    const od = parseInt(match[6]);
                    const makeup = parseInt(match[7]); // Captured Makeup
                    const absent = parseInt(match[8]);
                    
                    // Logic Update: Attended includes Present + OD + Makeup
                    const totalAttended = present + od + makeup;
                    const totalHeld = totalAttended + absent;
                    
                    let currentPercent = 0;
                    if (totalHeld > 0) {
                        currentPercent = (totalAttended / totalHeld) * 100;
                    }

                    // Calculation Logic
                    let statusHtml = "";
                    let rowClass = "";
                    
                    if (currentPercent >= target) {
                        // Safe: Calculate Bunks
                        const maxBunks = Math.floor((totalAttended * 100 / target) - totalHeld);
                        globalBunk += (maxBunks > 0 ? maxBunks : 0);
                        
                        rowClass = "bg-green-50/50 hover:bg-green-50";
                        if (maxBunks > 0) {
                            statusHtml = `<span class="text-green-700 font-medium">Leave <strong>${maxBunks}</strong> classes</span>`;
                        } else {
                            statusHtml = `<span class="text-green-600">On Track (Don't miss next)</span>`;
                        }
                    } else {
                        // Danger: Calculate Recovery
                        const required = Math.ceil(((target * totalHeld) - (100 * totalAttended)) / (100 - target));
                        globalNeed += required;
                        
                        rowClass = "bg-red-50/50 hover:bg-red-50";
                        statusHtml = `<span class="text-red-600 font-bold">Attend ${required} Next</span>`;
                    }

                    if (totalHeld === 0) {
                        rowClass = "";
                        statusHtml = `<span class="text-gray-400">No classes yet</span>`;
                    }

                    // Append Row
                    const row = `
                        <tr class="border-b transition duration-150 ${rowClass}">
                            <td class="px-6 py-4">
                                <div class="font-medium text-slate-800">${subjectName}</div>
                                <div class="text-xs text-slate-500">${match[2]}</div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${type === 'Lab' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                    ${type}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-center text-slate-600 font-mono text-xs">
                                ${totalAttended} / ${totalHeld}
                            </td>
                            <td class="px-6 py-4 text-center font-bold ${currentPercent < target ? 'text-red-500' : 'text-green-500'}">
                                ${currentPercent.toFixed(2)}%
                            </td>
                            <td class="px-6 py-4 text-center text-sm">
                                ${statusHtml}
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });

            // Update Dashboard Summary
            document.getElementById('totalNeed').innerText = globalNeed;
            document.getElementById('totalBunk').innerText = globalBunk;

            if (!hasData) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-red-500">
                    Could not parse data. Ensure you copied the "Subject Code" and "Makeup" columns correctly.
                </td></tr>`;
            }
        }
    </script>
</body>
</html>